<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capsule Integration Test</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui; padding: 20px; }
    .test-section { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
    .test-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
    .test-result { margin-top: 10px; padding: 10px; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .preview { border: 2px solid #007bff; padding: 20px; margin: 10px 0; min-height: 200px; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>🧪 Capsule Compilation Integration Test</h1>
  <p>Testing real-world capsule compilation and interaction in browser environment</p>

  <div class="test-section">
    <div class="test-title">Test 1: Basic Capsule with Dependencies</div>
    <div id="preview1" class="preview"></div>
    <div id="result1" class="test-result"></div>
  </div>

  <div class="test-section">
    <div class="test-title">Test 2: Complex Multi-Component App</div>
    <div id="preview2" class="preview"></div>
    <div id="result2" class="test-result"></div>
  </div>

  <div class="test-section">
    <div class="test-title">Test 3: Circular Reference Handling</div>
    <div id="preview3" class="preview"></div>
    <div id="result3" class="test-result"></div>
  </div>

  <script type="text/javascript">
    // Helper function to compile and run capsules
    function compileCapsules(capsules, mainComponent, targetId, resultId) {
      try {
        const compiledComponents = {};

        // First pass: compile all components
        Object.entries(capsules).forEach(([name, source]) => {
          try {
            // Remove imports
            const cleanSource = source.split('\n')
              .filter(line => !line.trim().startsWith('import '))
              .join('\n');

            // Transform with Babel
            const transformed = Babel.transform(cleanSource, {
              filename: `${name}.tsx`,
              presets: ['env', 'react', 'typescript'],
              sourceType: 'module'
            });

            // Create component function
            const componentFunc = new Function(
              'React', 'useState', 'useEffect', 'compiledComponents',
              `
              const exports = {};
              const module = { exports };

              // Mock require for component imports
              const require = (path) => {
                const componentName = path.split('/').pop()?.replace(/\\.(tsx|jsx|ts|js)$/, '')
                  ?.split('-').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join('');
                if (compiledComponents[componentName]) {
                  return { default: compiledComponents[componentName] };
                }
                console.warn('Component not found:', componentName);
                return { default: () => React.createElement('div', null, 'Missing: ' + componentName) };
              };

              ${transformed.code}

              return module.exports.default || module.exports || exports.default || exports;
              `
            );

            // Store for second pass
            compiledComponents[name] = { func: componentFunc };
          } catch (err) {
            console.error(`Failed to compile ${name}:`, err);
            compiledComponents[name] = {
              func: () => () => React.createElement('div', { style: { color: 'red' } }, `Error in ${name}`)
            };
          }
        });

        // Second pass: execute with all components available
        Object.entries(compiledComponents).forEach(([name, component]) => {
          try {
            const finalComponent = component.func(
              React,
              React.useState,
              React.useEffect,
              compiledComponents
            );
            compiledComponents[name] = finalComponent;
          } catch (err) {
            console.error(`Failed to finalize ${name}:`, err);
            compiledComponents[name] = () => React.createElement('div', { style: { color: 'red' } }, `Error in ${name}`);
          }
        });

        // Render the main component
        const MainComponent = compiledComponents[mainComponent];
        if (MainComponent) {
          const root = ReactDOM.createRoot(document.getElementById(targetId));
          root.render(React.createElement(MainComponent));

          document.getElementById(resultId).className = 'test-result success';
          document.getElementById(resultId).innerHTML = '✅ Component rendered successfully!';
        } else {
          throw new Error(`Main component ${mainComponent} not found`);
        }

      } catch (error) {
        console.error('Compilation error:', error);
        document.getElementById(resultId).className = 'test-result error';
        document.getElementById(resultId).innerHTML = '❌ Error: ' + error.message;
      }
    }

    // Test 1: Basic capsules with dependencies
    const test1Capsules = {
      'Button': `
        export default function Button({ onClick, children, variant = 'primary' }) {
          const styles = {
            primary: 'bg-blue-500 text-white hover:bg-blue-600',
            secondary: 'bg-gray-500 text-white hover:bg-gray-600'
          };

          return React.createElement('button', {
            className: 'px-4 py-2 rounded ' + styles[variant],
            onClick: onClick
          }, children);
        }
      `,
      'Counter': `
        import Button from './components/button';

        export default function Counter() {
          const [count, setCount] = useState(0);

          return React.createElement('div', { className: 'p-4 border rounded' },
            React.createElement('h2', { className: 'text-xl font-bold mb-2' }, 'Counter: ' + count),
            React.createElement('div', { className: 'flex gap-2' },
              React.createElement(Button, {
                onClick: () => setCount(count - 1),
                variant: 'secondary'
              }, 'Decrement'),
              React.createElement(Button, {
                onClick: () => setCount(count + 1)
              }, 'Increment')
            )
          );
        }
      `
    };

    // Test 2: Complex multi-component app
    const test2Capsules = {
      'Input': `
        export default function Input({ value, onChange, placeholder }) {
          return React.createElement('input', {
            className: 'border px-3 py-2 rounded',
            value: value,
            onChange: onChange,
            placeholder: placeholder
          });
        }
      `,
      'TodoItem': `
        export default function TodoItem({ todo, onToggle, onDelete }) {
          return React.createElement('div', {
            className: 'flex items-center gap-2 p-2 border-b'
          },
            React.createElement('input', {
              type: 'checkbox',
              checked: todo.completed,
              onChange: () => onToggle(todo.id)
            }),
            React.createElement('span', {
              className: todo.completed ? 'line-through text-gray-500' : ''
            }, todo.text),
            React.createElement('button', {
              className: 'ml-auto text-red-500',
              onClick: () => onDelete(todo.id)
            }, '❌')
          );
        }
      `,
      'TodoList': `
        import TodoItem from './components/todo-item';

        export default function TodoList({ todos, onToggle, onDelete }) {
          if (todos.length === 0) {
            return React.createElement('p', {
              className: 'text-gray-500 text-center p-4'
            }, 'No todos yet. Add one above!');
          }

          return React.createElement('div', { className: 'border rounded mt-4' },
            todos.map(todo =>
              React.createElement(TodoItem, {
                key: todo.id,
                todo: todo,
                onToggle: onToggle,
                onDelete: onDelete
              })
            )
          );
        }
      `,
      'TodoApp': `
        import Input from './components/input';
        import TodoList from './components/todo-list';

        export default function TodoApp() {
          const [todos, setTodos] = useState([
            { id: 1, text: 'Test capsule compilation', completed: true },
            { id: 2, text: 'Verify dependency resolution', completed: false }
          ]);
          const [inputValue, setInputValue] = useState('');

          const addTodo = () => {
            if (inputValue.trim()) {
              setTodos([...todos, {
                id: Date.now(),
                text: inputValue,
                completed: false
              }]);
              setInputValue('');
            }
          };

          const toggleTodo = (id) => {
            setTodos(todos.map(todo =>
              todo.id === id ? { ...todo, completed: !todo.completed } : todo
            ));
          };

          const deleteTodo = (id) => {
            setTodos(todos.filter(todo => todo.id !== id));
          };

          return React.createElement('div', { className: 'p-4' },
            React.createElement('h1', { className: 'text-2xl font-bold mb-4' }, 'Todo App (Multi-Capsule)'),
            React.createElement('div', { className: 'flex gap-2 mb-4' },
              React.createElement(Input, {
                value: inputValue,
                onChange: (e) => setInputValue(e.target.value),
                placeholder: 'Add a todo...'
              }),
              React.createElement('button', {
                className: 'bg-green-500 text-white px-4 py-2 rounded',
                onClick: addTodo
              }, 'Add')
            ),
            React.createElement(TodoList, {
              todos: todos,
              onToggle: toggleTodo,
              onDelete: deleteTodo
            })
          );
        }
      `
    };

    // Test 3: Circular reference handling (should fail gracefully)
    const test3Capsules = {
      'ComponentA': `
        import ComponentB from './components/component-b';

        export default function ComponentA() {
          const [show, setShow] = useState(false);

          return React.createElement('div', { className: 'p-4 border' },
            React.createElement('h3', null, 'Component A'),
            React.createElement('button', {
              className: 'bg-blue-500 text-white px-3 py-1 rounded',
              onClick: () => setShow(!show)
            }, 'Toggle B'),
            show && React.createElement(ComponentB)
          );
        }
      `,
      'ComponentB': `
        import ComponentA from './components/component-a';

        export default function ComponentB() {
          return React.createElement('div', { className: 'p-2 ml-4 border-l' },
            React.createElement('h4', null, 'Component B'),
            React.createElement('p', { className: 'text-sm text-gray-600' },
              'This would create circular reference if both rendered')
          );
        }
      `
    };

    // Run tests after page loads
    window.addEventListener('load', () => {
      console.log('Running capsule integration tests...');

      // Test 1
      setTimeout(() => {
        console.log('Running Test 1: Basic Capsule with Dependencies');
        compileCapsules(test1Capsules, 'Counter', 'preview1', 'result1');
      }, 100);

      // Test 2
      setTimeout(() => {
        console.log('Running Test 2: Complex Multi-Component App');
        compileCapsules(test2Capsules, 'TodoApp', 'preview2', 'result2');
      }, 500);

      // Test 3
      setTimeout(() => {
        console.log('Running Test 3: Circular Reference Handling');
        compileCapsules(test3Capsules, 'ComponentA', 'preview3', 'result3');
      }, 1000);
    });
  </script>
</body>
</html>